FROM node:16-alpine
RUN apk update

ARG NEXT_PUBLIC_GOOGLE_ANALYTICS_ENABLED
ARG NEXT_PUBLIC_GOOGLE_ANALYTICS_TAG_ID
ARG SERVER_PROTOCOL
ARG SERVER_IP
ARG SERVER_PORT
ARG CMS_PROTOCOL
ARG CMS_IP
ARG CMS_PORT
ARG CMS_API_TOKEN

COPY client/package.json client/package.json
COPY client/yarn.lock client/yarn.lock
WORKDIR /client/
RUN yarn
COPY --from=desbordante_server:latest /server/schema.json /server/schema.json
COPY --from=desbordante_cms:latest /cms/schema.graphql /cms/schema.graphql
COPY client/ /client/
RUN yarn codegen:server
RUN yarn codegen:cms
RUN yarn build
ENTRYPOINT ["yarn", "start"]
